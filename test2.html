<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			rel="stylesheet"
			href="//cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.css"
		/>
		<title>Speech Doodle</title>
	</head>
	<body style="padding:50px;">
		<h1>Speech to text test</h1>
		<div id="controls">
			<button id="recordButton">Record</button>
			<button id="transcribeButton" disabled>Get transcription</button>
		</div>
		<div id="output"></div>
		<script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>

		<!-- CLIENT JS -->
		<script>
			let rec = null
			let audioStream = null

			const recordButton = document.getElementById('recordButton')
			const transcribeButton = document.getElementById('transcribeButton')

			recordButton.addEventListener('click', startRecording)
			transcribeButton.addEventListener('click', transcribeText)

			function startRecording() {
				let constraints = { audio: true, video: false }

				recordButton.disabled = true
				transcribeButton.disabled = false

				navigator.mediaDevices
					.getUserMedia(constraints)
					.then(function(stream) {
						const audioContext = new window.AudioContext()
						audioStream = stream
						const input = audioContext.createMediaStreamSource(
							stream
						)
						rec = new Recorder(input, { numChannels: 1 })
						rec.record()
					})
					.catch(function(err) {
						recordButton.disabled = false
						transcribeButton.disabled = true
					})
			}

			function transcribeText() {
				transcribeButton.disabled = true
				recordButton.disabled = false
				rec.stop()
				audioStream.getAudioTracks()[0].stop()
				rec.exportWAV(uploadSoundData)
			}

			function uploadSoundData(blob) {
				let filename = new Date().toISOString()
				let xhr = new XMLHttpRequest()
				xhr.onload = function(e) {
					if (this.readyState === 4) {
						document.getElementById(
							'output'
						).innerHTML = `<br><br><strong>Result: </strong>${e.target.responseText}`
					}
				}
				let formData = new FormData()
				formData.append('audio_data', blob, filename)
				xhr.open('POST', 'http://localhost:3000/upload_sound', true)
				xhr.send(formData)
			}
		</script>
	</body>
</html>
